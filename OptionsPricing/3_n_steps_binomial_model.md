# [John Hull教材笔记]期权定价入门[3]: 二阶Binomial案例和N阶公式

虽然我不是数学或者金融专业的, 但既然在这个领域工作了, 就开始系统性地学习一下.

这篇文章按我自己的理解整理了John C. Hull的《Options, Futures, and Other Derivatives》相应的章节, 有删减, 有调整小节顺序, 细节以原文为主, 有问题欢迎指出.

防杠精声明: 如果觉得文章有错漏麻烦指出具体错在哪, 或给出正确的答案解释, 或者相应的引用来源.


## 二阶Binomial模型 - 案例

根据前面整理出来的一阶Binomial模型的期权定价公式:

$$f =  e^{-rT}[p f_u  + (1-p) f_d ] \text{ ,  }  p = \frac{(e^{rT} - d)} {u-d}$$

其中:

$u$是股票上涨幅度, $f_u$ 是股票上涨后的期权价格

$d$是股票下跌幅度, $f_d$ 是股票下跌后的期权价格

$r$是无风险利率

$T$是以年为单位的时间

$p$是在风险中性环境下的股票上涨概率

再看看我们上个案例里的具体数值, 我们考虑的是3个月的一阶Binomial模型的定价:

![image](https://user-images.githubusercontent.com/5571030/212555167-33cd4cb4-2cde-41fd-94c8-6f087d3a36d0.png)

现在我们来构建一个二阶Binomial模型案例, 把之前的3个月扩展到6个月, 还是同样的行权价$21, 并且假设股票的涨跌幅度一直都是 $u=1.1$ 和 $d=0.9$, 无风险利率 $r=0.12$, 两个阶段的时间 $T=0.25$ (3个月, 合起来6个月), 那么我们可以构建出下面的图: 

![image](https://user-images.githubusercontent.com/5571030/212555782-88b960f2-05cb-41bf-b70d-10fc7f5eefc9.png)

因为行权价(Strike)是$21, 从右往左看, 我们可以直接得到D, E, F节点的期权价, 通过公式反推可得B, C节点的期权价, 最后反推出A节点的期权价, 也就是我们要定的期权价.

其中B节点期权价: 

我们先算一下风险中性环境下的上涨概率: 

$p = \frac{(e^{rT} - d)} {u-d}$

$p = \frac{(e^{0.12 \times 0.25} - 0.9)} {1.1-0.9} = 0.6523$

再看一下B节点期权, 因为有两步, 我们可以把D节点的期权价格标为 $f_{uu}$ (上涨两次后的期权价格), 把E节点的期权价格标为 $f_{ud}$ (上涨又下跌后的期权价格):

$f_u =  e^{-rT}[p f_{uu}  + (1-p) f_{ud} ]$
 
$f_u =  e^{-0.12 \times 0.25}[0.6523 \times 3.2  + (1-0.6523) \times 0 ] = 2.0257$

同理我们可以算出A节点期权价: 

$f =  e^{-rT}[p f_u  + (1-p) f_d ]$

$f =  e^{-0.12 \times 0.25}[0.6523 \times 2.0257  + (1-0.6523) \times 0 ] = 1.2823$

![image](https://user-images.githubusercontent.com/5571030/212556248-55d13c6d-7714-44bb-9fb7-e38b44206250.png)


## 二阶Binomial模型 - 公式

其实上述案例也暗示了二阶或者n阶Binomial模型, 因为我们的一阶公式如下: 

$$f =  e^{-rT}[p f_u  + (1-p) f_d ] \text{ ,  }  p = \frac{(e^{rT} - d)} {u-d}$$

并且我们现在不是单纯看一个时间段 $T$ 了, 我们把 $T$ 替换成 $&Delta;t$, 所以我们的一阶公式可以改成: 

$$f =  e^{-r&Delta;t}[p f_u  + (1-p) f_d ] \text{ ,  }  p = \frac{(e^{r&Delta;t} - d)} {u-d}$$


这时候只有 $f_u$ 和 $f_d$, 在二阶模型里我们将会出现 $f_{uu}$, $f_{ud}$, $f_{dd}$, 并且 $f_u$ 和 $f_d$ 暂时未知, 需要套用上述公式推导出来, 那么我们看看: 

$f_u =  e^{-r&Delta;t}[p f_{uu}  + (1-p) f_{ud} ]$

$f_d =  e^{-r&Delta;t}[p f_{ud}  + (1-p) f_{dd} ]$

$f =  e^{-r&Delta;t}[p f_u  + (1-p) f_d ]$

这三个公式结合一下就可以消除中间阶段的 $f_u$ 和 $f_d$ , 我们得出: 

$$f =  e^{-2r&Delta;t}[p^{2} f_{uu}  + 2p(1-p) f_{ud} + (1-p)^{2}f_{dd} ]$$


## 上涨/下跌幅度( u 和 d )的数值我们怎么决定的?

```
这里我们又要偏离教材原本的顺序了, 教材这里就开始讲别的案例, 然后直接给出了结论, 背景知识却在下一章才给出, 有点太绕, 我这直接把我们将会有的疑惑, 背景和结论一并整理出来. 
```

看到这里不知道各位会不会有一个疑问, 为什么我们假设上涨幅度就是 $u=1.1$, 下跌幅度就是 $d=0.9$, 换到别的案例我们怎么定义这两个值? 

实际上 $u$ 和 $d$ 应该是根据我们选的波动率而决定的(The parameter $u$ and $d$ should be chosen to match volatility). 而我们定义的股票或者其他资产的波动率 $&sigma;$ ,可以用来表示一小段时间 $&Delta;t$ 内的标准差, 也就是 $&sigma;\sqrt{&Delta;t}$, 相应的方差是 $&sigma;^{2}&Delta;t$, 这些定义又是从哪里来的呢? 在这里我们就要涉及一些随机过程的背景知识了. 

### 马尔可夫性质(The Markov Property)

马尔可夫过程(Markov process)是一类特殊的随机过程, 变量在任意时刻之后的值仅与当前值有关, 与之前的历史值无关. 也就是说, 该过程的当前值包含了其对未来做预测所需的全部信息. 

通常我们假设股票价格的变动是一个马尔可夫过程. 假设现在某个股票的价格是$100, 我们对这个股票未来的预测不会受当前时刻之前的任何时刻的股价影响, 我们拥有的唯一有效的信息就是当前的$100.


### 连续时间随机过程(Continuous-time Stochastic Processes)

随机过程有离散时间(discrete time)和连续时间(continuous time)的区分, 我们这里主要看连续时间的随机过程. 我们先来定义一些符号, 我们用 $&Phi;(m,v)$ 来表示一个正态分布, 其中 $m$ 表示平均值(mean), $v$ 表示方差(variance). 

考虑一个遵循马尔可夫过程的变量, 假设它现在的值是10, 并且它一年之中的变化符合平均值是0, 方差是1的正态分布 $&Phi;(0,1)$. 

__问题__: 如果时间扩展到2年, 这个变量的概率分布是多少呢? 

__答案__: $&Phi;(0,2)$

__原因__: 因为这个变量遵循马尔可夫过程, 所以变量每一年的概率分布都是互相独立的. 当我们把两个独立的正态分布相加的时候, 结果还是一个正态分布, 但是平均数是两者之和, 方差也是两者之和. 所以第一年的概率分布是 $&Phi;(0,1)$ , 两年的概率分布就是 $&Phi;(0,1) + &Phi;(0,1) = &Phi;(0,2)$, 也就是说变量在两年的变化符合平均值0, 方差2, 标准差 $\sqrt{2}$

__问题__: 如果时间缩短到0.5年, 这个变量的概率分布是多少呢? 

__答案__: $&Phi;(0,0.5)$

__原因__: 同理我们可以反推, 0.5年的分布+0.5年的分布=1年的分布. 那么0.5年的分布就是 $&Phi;(0,0.5)$

__总结__: 我们可以总结出以下规律:

2年的概率分布: $&Phi;(0,2)$

1年的概率分布: $&Phi;(0,1)$

0.5年的概率分布: $&Phi;(0,0.5)$

0.25年的概率分布: $&Phi;(0,0.25)$

$T$ 年的概率分布: $&Phi;(0,T)$

$&Delta;t$年的概率分布: $&Phi;(0,&Delta;t)$


### 维纳过程/布朗运动(Wiener process/Brownian motion)

其实上面拥有平均值0, 方差等于时间段的分布 $&Phi;(0,T)$ 这样一类特殊的马尔可夫随机过程被称为维纳过程(Wiener process), 这个在物理也用来描述小分子的无序运动, 也称布朗运动(Brownian motion). 维纳过程有一个性质: 

在一小段时间 $&Delta;t$ 内 $&Delta;z$ 的变化满足: 

$$ &Delta;z = \epsilon \sqrt{&Delta;t} $$

其中 $\epsilon$ 是一个平均值为0, 方差为1的正态分布 $&Phi;(0,1)$

补充说明: 根据正态分布的性质: $&Phi;(0,1) \sqrt{&Delta;t} = &Phi;(0,(\sqrt{&Delta;t \times 1})^{2}) = &Phi;(0,&Delta;t)$, 参考: https://zh.wikipedia.org/zh-cn/正态分布#性質 . 

### 回到波动率

根据上面的背景知识, 假设我们的股票价格是符合维纳过程的随机变量, 那么一小段时间 $&Delta;t$ 内的股票价格的变动可以符合正态分布 $&Phi;(0, &sigma;^{2} &Delta;t)$, 那么标准差也就是 $&sigma;\sqrt{&Delta;t}$ , 方差是 $&sigma; ^{2}&Delta;t$.

补充说明: 在 $sigma=1$ 的特殊情况下, 股票的变化就是一个符合 $&Phi;(0,&Delta;t)$ 的标准维纳过程.

### 根据波动率决定上涨/下跌幅度(u和d)

我们再看一个期望的性质: 假设一个随机变量 $X$ 的期望是 $E(X)$, 那么它的方差是 $E(X^{2}) - \[E(X)\]^{2}$

再看我们的股票价格变动, 股票上涨的概率是 $p$, 涨幅是 $u-1$, 股票下跌的概率是 $1-p$, 跌幅是 $d-1$, 那么价格变动的期望: 

$$ E(股票价格变动) = p(u-1) + (1-p)(d-1) $$

根据期望的性质, 股票价格变动的方差: 

$$ Var(股票变动) = E(股票价格变动^{2}) - \[E(股票价格变动)\]^{2} = p(u-1)^{2} + (1-p)(d-1)^{2} - \[ p(u-1) + (1-p)(d-1) \]^{2} = &sigma; ^{2}&Delta;t $$

回忆一下我们之前算出的 $p$是: 

$$p = \frac{(e^{r&Delta;t} - d)} {u-d}$$

代入化简后我们可得:

$$e^{r&Delta;t}(u+d) - ud - e^{2r&Delta;t} = &sigma; ^{2}&Delta;t $$


于是我们就把他们算一算, 因为 $&Delta; t$ 本身就很小了, 所以把 $&Delta; t^{2}$ 和以上更高次都当作0忽略掉, 得出结果:

$$u = e^{&sigma; \sqrt{&Delta; t}} $$

$$d = e^{- &sigma; \sqrt{&Delta; t}}$$

```
这里书中就直接跳过所有步骤出结果了, 下面我还还是想尝试抠一下细节
```

上面等式中有两个未知数 $u$ 和 $d$ . 然而本书, 和其他很多学校的教案, 甚至原论文 _Cox, Ross and Rubinstein (1979)_ 都没有给出计算过程. 哥伦比亚大学的教案稍微详细一些, 说明了 $u$ 和 $d$的关系, 细节见这里: http://www.columbia.edu/~ks20/FE-Notes/4700-07-Notes-GBM.pdf

我觉得这是一个很重要的假设:

这里有必要做一个假设就是 $ud = 1$ , 也就是 $u = 1/d$ . 因为必须这样假设, 在我们的Binomial模型里才能保证股价 $S_0$ 在经过上涨下跌后能回到原来的位置, 反之也一样, 也就是 $udS_0 = duS_0 = S_0$. 

然后我自己尝试算了一下也算不出来...只好尝试把答案往里套:

$$e^{r&Delta;t}(e^{&sigma; \sqrt{&Delta; t}} + e^{- &sigma; \sqrt{&Delta; t}}) - 1 - e^{2r&Delta;t} = &sigma; ^{2}&Delta;t $$

因为 $e^{x}$ 可以展开为 $e^{x} = 1 + x + \frac{x^{2}}{2!} + \frac{x^{3}}{3!} + ...$ , 所以我们可以先把带入的 $e^{&sigma; \sqrt{&Delta; t}}$ 展开三项:

$$e^{r&Delta;t}(1 + &sigma; \sqrt{&Delta; t} + \frac{&sigma;^{2} &Delta; t}{2!} + 1 - &sigma; \sqrt{&Delta; t} + \frac{&sigma;^{2} &Delta; t}{2!}) - 1 - e^{2r&Delta;t} = &sigma; ^{2}&Delta;t $$

整理后:

$$e^{r&Delta;t}(2 + &sigma;^{2} &Delta; t) - 1 - e^{2r&Delta;t} = &sigma; ^{2}&Delta;t $$

再对剩下 $e^{r&Delta;t}$ 的展开两项: 

$$(1+r&Delta;t)(2 + &sigma;^{2} &Delta; t) - 1 - (1+2r&Delta;t) = &sigma; ^{2}&Delta;t $$

整理后:

$$(2+2r&Delta;t + &sigma;^{2} &Delta; t + r&sigma;^{2} &Delta; t^{2}) - (2+2r&Delta;t) = &sigma; ^{2}&Delta;t $$

因为 $&Delta; t$ 本来就很小, 我们可以把 $&Delta; t^{2}$ 当作0忽略掉:

$$(2+2r&Delta;t + &sigma;^{2} &Delta; t) - (2+2r&Delta;t) = &sigma; ^{2}&Delta;t $$

最后等式成立:

$$&sigma;^{2} &Delta; t = &sigma; ^{2}&Delta;t $$


把答案带进去勉强验证等式成立, 也就是说以下的 $u$ 和 $d$ 确实是一个解:


$$u = e^{&sigma; \sqrt{&Delta; t}} $$

$$d = e^{- &sigma; \sqrt{&Delta; t}}$$

## Binomial树模型公式

至此, 我们通过一阶和二阶Binomial模型, 也可以观察出规律:

只要我们定义了每一阶的上涨幅度 $u$, 下跌幅度 $d$, 和上涨概率 $p$, 并且假设或者通过观察得出股票或者其他资产的波动率 $&sigma;$, 再把无风险利率 $r$ 带入, 我们就可以生成Binomial树模型, 并且当我们把该模型的阶数增加到一定程度, 我们就可以算出精确的期权价格了. 

那么总结一下, 由以下公式即可构成完整的Binomial树模型:

$$u = e^{&sigma; \sqrt{&Delta; t}} $$

$$d = e^{- &sigma; \sqrt{&Delta; t}}$$

$$p = \frac{(e^{r&Delta; t} - d)} {u-d}$$
